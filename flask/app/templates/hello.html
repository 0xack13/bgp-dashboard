<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>BGP Dashboard</title>

    <!-- Bootstrap -->
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../static/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../static/vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../static/vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">

    <!-- Custom Theme Style -->
    <link href="../static/css/custom.css" rel="stylesheet">
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">


        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav>
              <div class="navbar-left" style="padding-left: 30px;">
                <h1 style="color: #34495e;">ASN3701</h1>
                <h2><i>NERONET - Network for Education and Research in Oregon (NERO)</i></h2>
              </div>
              <div class="title_right">
                <div class="col-md-2 col-sm-2 col-xs-12 form-group pull-right top_search">
                  <form onsubmit="location.href='/bgp/api/v1.0/asn/' + document.getElementById('asnInput').value; return false;" class="input-group">
                    <input type="text" id="asnInput" class="form-control" placeholder="ASN Search...">
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit">Go!</button>
                    </span>
                  </form>
                </div>
              </div>
              <div class="title_right">
                <div class="col-md-2 col-sm-2 col-xs-12 form-group pull-right top_search">
                  <form onsubmit="location.href='/bgp/api/v1.0/ip/' + document.getElementById('ipInput').value.split('/')[0]; return false;" class="input-group">
                    <input type="text" id="ipInput" class="form-control" placeholder="IP Search...">
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit">Go!</button>
                    </span>
                  </form>
                </div>
              </div>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="row top_tiles">
              <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                <div class="tile-stats">
                  <div class="icon"><i id="peersIDIcon"></i></div>
                  <div class="count" id="peersID">0</div>
                  <h3>Peer Count</h3>
                  <div>
                    <p class="count_bottom pull-right" id="peersIDChangeTime"></p>
                    <p>Active BGP peering sessions</p>
                  </div>
                  <div class="clearfix"></div>
                  <p class="peers_count_sparkline pull-right" style="margin-right: 5px; margin-left: 5px;">Loading..</p>
                </div>
              </div>
              <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                <div class="tile-stats">
                  <div class="icon"><i id="ipv4TableSizeIcon"></i></div>
                  <div class="count" id="ipv4TableSize">0</div>
                  <h3>IPv4 Prefixes</h3>
                  <div>
                    <p class="count_bottom pull-right" id="ipv4TableSizeChangeTime"></p>
                    <p>IPv4 BGP Table Size</p>
                  </div>
                  <div class="clearfix"></div>
                  <p class="ipv4_table_sparkline pull-right" style="margin-right: 5px; margin-left: 5px;">Loading..</p>
                </div>
              </div>
              <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                <div class="tile-stats">
                  <div class="icon"><i id="ipv6TableSizeIcon"></i></div>
                  <div class="count" id="ipv6TableSize">0</div>
                  <h3>IPv6 Prefixes</h3>
                  <div>
                    <p class="count_bottom pull-right" id="ipv6TableSizeChangeTime"></p>
                    <p>IPv6 BGP Table Size</p>
                  </div>
                  <div class="clearfix"></div>
                  <p class="ipv6_table_sparkline pull-right"  style="margin-right: 5px; margin-left: 5px;">Loading..</p>
                </div>
              </div>
              <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                <div class="tile-stats">
                  <div class="icon"><i id="nexthopIPCountIcon"></i></div>
                  <div class="count" id="nexthopIPCount">0</div>
                  <h3>Next Hop Addresses</h3>
                  <div>
                    <p class="count_bottom pull-right" id="nexthopIPCountChangeTime"></p>
                    <p>Unique Egress IP Addresses</p>
                  </div>
                  <div class="clearfix"></div>
                  <p class="nexthop_count_sparkline pull-right" style="margin-right: 5px; margin-left: 5px;">Loading..</p>
                </div>
              </div>
            </div>
            <!--  Second Row -->
            <div class="row top_tiles">
              <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                <div class="tile-stats">
                  <div class="icon"><i id="avgAsPathLengthIcon"></i></div>
                  <div class="count" id="avgAsPathLength">0</div>
                  <h3>Average AS Path Length</h3>
                  <div>
                    <p class="count_bottom pull-right" id="avgAsPathLengthChangeTime"></p>
                    <p>Hops between Source and Destination ASNs</p>
                  </div>
                  <div class="clearfix"></div>
                  <p class="avg_as_path_length_sparkline pull-right" style="margin-right: 5px; margin-left: 5px;">Loading..</p>
                </div>
              </div>
              <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                <div class="tile-stats">
                  <div class="icon"><i id="customerIPv4PrefixesIcon"></i></div>
                  <div class="count" id="customerIPv4Prefixes">0</div>
                  <h3>Customer IPv4 Prefixes</h3>
                  <div>
                    <p class="count_bottom pull-right" id="customerIPv4PrefixesChangeTime"></p>
                    <p>Customer & Orginated IPv4 Prefix Count</p>
                  </div>
                  <div class="clearfix"></div>
                  <p class="customer_ipv4_prefixes_sparkline pull-right" style="margin-right: 5px; margin-left: 5px;">Loading..</p>
                </div>
              </div>
              <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                <div class="tile-stats">
                  <div class="icon"><i id="customerIPv6PrefixesIcon"></i></div>
                  <div class="count" id="customerIPv6Prefixes">0</div>
                  <h3>Customer IPv6 Prefixes</h3>
                  <div>
                    <p class="count_bottom pull-right" id="customerIPv6PrefixesChangeTime"></p>
                    <p>Customer & Orginated IPv6 Prefix Count</p>
                  </div>
                  <div class="clearfix"></div>
                  <p class="customer_ipv6_prefixes_sparkline pull-right" style="margin-right: 5px; margin-left: 5px;">Loading..</p>
                </div>
              </div>
              <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                <div class="tile-stats">
                  <div class="icon"><i id="customerCountIcon"></i></div>
                  <div class="count" id="customerCount">0</div>
                  <h3>BGP Customers</h3>
                  <div>
                    <p class="count_bottom pull-right" id="customerCountChangeTime"></p>
                    <p>BGP Connect Customers</p>
                  </div>
                  <div class="clearfix"></div>
                  <p class="customer_count_sparkline pull-right" style="margin-right: 5px; margin-left: 5px;">Loading..</p>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>Peer Data <small>Table</small></h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <div class="col-md-9 col-sm-12 col-xs-12">
                      <div class="demo-container">
                        <table id="datatable" class="table table-striped table-bordered">
                      <thead>
                        <tr>
                          <th>ASN</th>
                          <th>Name</th>
                          <th>IPv4 Prefixes</th>
                          <th>IPv6 Prefixes</th>
                          <th>Details</th>
                        </tr>
                      </thead>


                      <tbody>
                        {% for peer in peers %}
                        <tr>
                          <td>{{ peer.asn }}</td>
                          <td>{{ peer.name }}</td>
                          <td>{{ peer.ipv4_count }}</td>
                          <td>{{ peer.ipv6_count }}</td>
                          <td><a href="/bgp/api/v1.0/asn/{{peer.asn}}">Details</a></td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                      </div>
                    </div>

                    <div class="col-md-3 col-sm-12 col-xs-12">
                      <div>
                        <div class="x_title">
                          <h2>Top Peers (Prefixes Recieved)</h2>

                          <div class="clearfix"></div>
                        </div>
                        <ul class="list-unstyled top_profiles scroll-view">
                          {% for peer in top_peers %}
                          <li class="media event">
                            <a class="pull-left border-blue profile_thumb">
                              <i class="fa fa-arrows-alt blue"></i>
                            </a>
                            <div class="media-body">
                              <a class="title" href="#">ASN {{ peer.asn }}</a>
                              <p><strong>{{ '{0:,}'.format(peer.count) }}</strong> Prefixes </p>
                              <p> <small>{{ peer.name }}</small>
                              </p>
                            </div>
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>



            <div class="row">
              <div class="col-md-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>BGP Community Details <small>Prefixes</small></h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <div class="row" style="border-bottom: 0px solid #E0E0E0; padding-bottom: 5px; margin-bottom: 5px;">
                      <div class="col-md-12">
                        <div class="row" style="text-align: center;">
                          <div id="graph_donut1" class="col-md-4" style="width:50%; height:180px;">
                            <h4 style="margin:0">Peering Prefix Count</h4>
                          </div>
                          <div id="graph_donut2" class="col-md-4" style="width:50%; height:180px;">
                            <h4 style="margin:0">Transt vs. Non-Transit</h4>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <!-- bar chart -->
              <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>IPv4 CIDR <small>Prefix Count</small></h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <div id="graph_bar" style="width:100%; height:280px;"></div>
                  </div>
                </div>
              </div>
              <!-- /bar charts -->

              <!-- bar charts group -->
              <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>IPv6 CIDR <small>Prefix Count</small></h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content1">
                    <div id="graph_bar_group" style="width:100%; height:280px;"></div>
                  </div>
                </div>
              </div>
              <div class="clearfix"></div>
              <!-- /bar charts group -->
              <div class="clearfix"></div>
              <!-- /bar charts group -->
            </div>
          </div>
        </div>
        <!-- /page content -->

        <!-- footer content -->
        <footer>
          <div class="pull-right">
            Gentelella - Bootstrap Admin Template by <a href="https://colorlib.com">Colorlib</a>
          </div>
          <div class="clearfix"></div>
        </footer>
        <!-- /footer content -->
      </div>
    </div>

    <!-- jQuery -->
    <script src="../static/vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../static/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../static/vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../static/vendors/nprogress/nprogress.js"></script>
    <!-- Chart.js -->
    <script src="../static/vendors/Chart.js/dist/Chart.min.js"></script>
    <!-- jQuery Sparklines -->
    <script src="../static/vendors/jquery-sparkline/dist/jquery.sparkline.min.js"></script>
    <!-- DateJS -->
    <script src="../static/vendors/DateJS/build/date.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="../static/vendors/moment/min/moment.min.js"></script>
    <script src="../static/vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <script src="../static/vendors/raphael/raphael.min.js"></script>
    <script src="../static/vendors/morris.js/morris.js"></script>
    <script src="../static/vendors/datatables.net/js/jquery.dataTables.min.js"></script>


    <!-- Custom Theme Scripts -->
    <!-- <script src="../static/js/custom.min.js"></script> -->
  <script>
    $(document).ready(function() {
      $('#datatable').dataTable(
        {"oLanguage": {
          "sSearch": "Filter Table: "
        }});
    });
  </script>

  <script>
  function up_or_down_checker(css_tag, data, json_tag)
  {
    var myDateFormat  = moment().format('MMM D YYYY, H:mm:ss');
    var css_tag_id   = '#' + css_tag;
    var css_tag_icon  = css_tag_id + 'Icon';
    var css_tag_change_time = css_tag_id + 'ChangeTime';

    if (jQuery(css_tag_id).text().replace(/\,/g,'') > data[json_tag])
    {
      jQuery(css_tag_icon).removeClass();
      jQuery(css_tag_icon).addClass("red fa fa-arrow-circle-down");
      diff = data[json_tag] - jQuery(css_tag_id).text().replace(/\,/g,'');
      diff = diff.toLocaleString('en-Us', {minimumFractiondigits: 0});
      jQuery(css_tag_change_time).html('<i class="red">' + diff  + '</i> at ' + myDateFormat + '&nbsp');
    }
    else if (jQuery(css_tag_id).text().replace(/\,/g,'') < data[json_tag])
    {
      jQuery(css_tag_icon).removeClass();
      jQuery(css_tag_icon).addClass("green fa fa-arrow-circle-up");
      diff = data[json_tag] - jQuery(css_tag_id).text().replace(/\,/g,'');
      diff = diff.toLocaleString('en-Us', {minimumFractiondigits: 0});
      jQuery(css_tag_change_time).html('<i class="green"> +' + diff  + '</i> at ' + myDateFormat + '&nbsp');
    }
  }

  var peer_count_sparkline_data = [];
  var ipv4_table_sparkline_data = [];
  var ipv6_table_sparkline_data = [];
  var nexthop_count_sparkline_data = [];
  var avg_as_path_length_data = [];
  var customer_count_data = [];
  var customer_ipv4_prefix_data = [];
  var customer_ipv6_prefix_data = [];

  function update_counters()
  {
    update_counters.count = update_counters.count || 0;
    jQuery.getJSON("/bgp/api/v1.0/stats", function(data)
    {
      if (update_counters.count > 0) //only update times after the first run
      {
        up_or_down_checker('peersID', data, 'peer_count');
        up_or_down_checker('ipv4TableSize', data, 'ipv4_table_size');
        up_or_down_checker('ipv6TableSize', data, 'ipv6_table_size');
        up_or_down_checker('nexthopIPCount', data, 'nexthop_ip_count');
        up_or_down_checker('avgAsPathLength', data, 'avg_as_path_length');
        up_or_down_checker('customerCount', data, 'customer_count');
        up_or_down_checker('customerIPv4Prefixes', data, 'customer_ipv4_prefixes');
        up_or_down_checker('customerIPv6Prefixes', data, 'customer_ipv6_prefixes');
      }

      update_counters.count += 1;

      jQuery('#peersID').text(data['peer_count'].toLocaleString('en-US', {minimumFractionDigits: 0}));
      jQuery('#ipv4TableSize').text(data['ipv4_table_size'].toLocaleString('en-US', {minimumFractionDigits: 0}));
      jQuery('#ipv6TableSize').text(data['ipv6_table_size'].toLocaleString('en-US', {minimumFractionDigits: 0}));
      jQuery('#nexthopIPCount').text(data['nexthop_ip_count'].toLocaleString('en-US', {minimumFractionDigits: 0}));
      jQuery('#avgAsPathLength').text(data['avg_as_path_length']);
      jQuery('#customerCount').text(data['customer_count']);
      jQuery('#customerIPv4Prefixes').text(data['customer_ipv4_prefixes']);
      jQuery('#customerIPv6Prefixes').text(data['customer_ipv6_prefixes']);
      jQuery('.peers_count_sparkline').sparkline(peer_count_sparkline_data);
      jQuery('.ipv4_table_sparkline').sparkline(ipv4_table_sparkline_data);
      jQuery('.ipv6_table_sparkline').sparkline(ipv6_table_sparkline_data);
      jQuery('.nexthop_count_sparkline').sparkline(nexthop_count_sparkline_data);
      jQuery('.avg_as_path_length_sparkline').sparkline(avg_as_path_length_data);
      jQuery('.customer_count_sparkline').sparkline(customer_count_data);
      jQuery('.customer_ipv4_prefixes_sparkline').sparkline(customer_ipv4_prefix_data);
      jQuery('.customer_ipv6_prefixes_sparkline').sparkline(customer_ipv6_prefix_data);


      //$('.dynamicbar').sparkline(myvalues, {type: 'bar', barColor: 'green'} );
      if (peer_count_sparkline_data.length >= 200)
      {
        peer_count_sparkline_data.shift();
        ipv4_table_sparkline_data.shift();
        ipv6_table_sparkline_data.shift();
        nexthop_count_sparkline_data.shift();
        avg_as_path_length_data.shift();
        customer_count_data.shift();
        customer_ipv4_prefix_data.shift();
        customer_ipv6_prefix_data.shift();
      }
      peer_count_sparkline_data.push(data['peer_count']);
      ipv4_table_sparkline_data.push(data['ipv4_table_size']);
      ipv6_table_sparkline_data.push(data['ipv6_table_size']);
      nexthop_count_sparkline_data.push(data['nexthop_ip_count']);
      avg_as_path_length_data.push(data['avg_as_path_length']);
      customer_count_data.push(data['customer_count']);
      customer_ipv4_prefix_data.push(data['customer_ipv4_prefixes']);
      customer_ipv6_prefix_data.push(data['customer_ipv6_prefixes']);
    });
  }

  jQuery(document).ready(update_counters());
  setInterval(function() { update_counters() }, 5000);

  </script>

     <!-- morris.js -->
      <script>
      $(document).ready(function() {
          Morris.Bar({
            element: 'graph_bar',
            data: [
              {%- for cidr in cidr_breakdown -%}
                {% if cidr.ip_version == 4 %}
                  {cidr: "/{{ cidr.mask }}", count: {{ cidr.count }}},
                {% endif %}
              {%- endfor -%}
            ],
            xkey: 'cidr',
            ykeys: ['count'],
            labels: ['count'],
            barRatio: 0.4,
            barColors: ['#26B99A', '#34495E', '#ACADAC', '#3498DB'],
            xLabelAngle: 60,
            hideHover: 'auto',
            resize: true
          });

          Morris.Bar({
            element: 'graph_bar_group',
            data: [
              {%- for cidr in cidr_breakdown -%}
                {% if cidr.ip_version == 6 %}
                  {cidr: "/{{ cidr.mask }}", count: {{ cidr.count }}},
                {% endif %}
              {%- endfor -%}
            ],
            xkey: 'cidr',
            ykeys: ['count'],
            labels: ['count'],
            barRatio: 0.4,
            barColors: ['#26B99A', '#34495E', '#ACADAC', '#3498DB'],
            xLabelAngle: 60,
            hideHover: 'auto',
            resize: true
          });

          Morris.Donut({
            element: 'graph_donut1',
            data: [
              {%- for comm in communities -%}
                {% if comm.community == "3701:392" %}
                  {label: 'NWAX', value: {{ comm.count }}},
                {% endif %}
                {% if comm.community == "3701:394" %}
                  {label: 'I2-CPS', value: {{ comm.count }}},
                {% endif %}
                {% if comm.community == "3701:395" %}
                  {label: 'SIX', value: {{ comm.count }}},
                {% endif %}
                {% if comm.community == "3701:380" %}
                  {label: 'Level3', value: {{ comm.count }}},
                {% endif %}
                {% if comm.community == "3701:391" %}
                  {label: 'I2-RE', value: {{ comm.count }}},
                {% endif %}
              {%- endfor -%}
            ],
            colors: ['#26B99A', '#34495E', '#ACADAC', '#3498DB', '#E74C3C'],
            formatter: function (y) {
              return y;
            },
            resize: true
          });

          Morris.Donut({
            element: 'graph_donut2',
            data: [
            {% set total_prefixes = data.ipv4_table_size + data.ipv6_table_size %}
            {%- for comm in communities -%}
              {% if comm.community == "3701:380" %}
                {label: 'Non-Transit', value: {{ (((comm.count - total_prefixes) / total_prefixes) * -100)|round }}},
                {label: 'Transit', value: {{ ((comm.count / total_prefixes) * 100)|round }}},
              {% endif %}
            {%- endfor -%}
            ],
            colors: ['#34495E', '#3498DB'],
            formatter: function (y) {
              return y + "%";
            },
            resize: true
          });

          // Morris.Donut({
          //   element: 'graph_donut3',
          //   data: [
          //   {%- for comm in communities -%}
          //     {% if comm.community == "3701:370" %}
          //       {label: 'Customer', value: {{ comm.count }}}
          //     {% endif %}
          //   {%- endfor -%}
          //   ],
          //   colors: ['#34495E'],
          //   formatter: function (y) {
          //     return y;
          //   },
          //   resize: true
          // });

        });
      </script>
      <!-- /morris.js -->

  </body>
</html>
